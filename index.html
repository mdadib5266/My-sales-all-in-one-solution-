<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Sales Tracker - All-in-One (v2.1 - PDF Fix)</title>
    <style>
        /* --- CSS STYLES (Same as previous, for brevity not repeated here, but include them) --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f0f2f5;
            color: #1c1e21;
            line-height: 1.4;
        }
        .container {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 8px 16px rgba(0,0,0,0.1);
            max-width: 900px;
            margin: 20px auto;
        }
        h1, h2, h3 {
            color: #1c1e21;
            margin-top: 0;
            margin-bottom: 0.75em;
        }
        h1 { font-size: 1.8em; }
        h2 { font-size: 1.5em; border-bottom: 1px solid #ccd0d5; padding-bottom: 0.3em; }
        hr {
            margin: 25px 0;
            border: 0;
            border-top: 1px solid #ccd0d5;
        }

        /* Form Styling */
        .form-section div, .settings-section div {
            margin-bottom: 12px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9em;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: calc(100% - 22px); /* Full width minus padding and border */
            padding: 10px;
            border: 1px solid #ccd0d5;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
        }
        input:focus, select:focus {
            border-color: #1877f2;
            box-shadow: 0 0 0 2px rgba(24, 119, 242, 0.2);
            outline: none;
        }
        button {
            background-color: #1877f2; /* Facebook Blue */
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #166fe5;
        }
        button.secondary {
            background-color: #e4e6eb;
            color: #1c1e21;
        }
        button.secondary:hover {
            background-color: #d8dbdf;
        }
        button.danger {
            background-color: #fa383e;
        }
        button.danger:hover {
            background-color: #e02c32;
        }
        .button-group button {
            margin-right: 8px;
        }
        .button-group button:last-child {
            margin-right: 0;
        }

        /* Table Styling */
        .table-responsive {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid #ccd0d5;
            border-radius: 6px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #dddfe2;
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
            vertical-align: top;
        }
        th {
            background-color: #f5f6f7;
            font-weight: 600;
            white-space: nowrap;
        }
        td .action-button, .list-item-actions button { /* Combined for consistency */
            font-size: 0.8em;
            padding: 5px 8px;
            margin-left: 5px; 
        }
        
        /* Product List & Custom Field Styling */
        #productList .list-item, #customFieldsList .list-item { 
            padding: 8px;
            border-bottom: 1px solid #e4e6eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #productList .list-item:last-child, #customFieldsList .list-item:last-child {
            border-bottom: none;
        }
        .list-item-info { flex-grow: 1; } 
        .field-name-display {
            font-weight: 500;
        }
        .list-item-actions { white-space: nowrap; }


        /* Summary section */
        #summarySection {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f6f7;
            border-radius: 6px;
            border: 1px solid #ccd0d5;
        }
        #summarySection p {
            margin: 8px 0;
            font-size: 0.95em;
        }
        #summarySection p strong {
            display: inline-block;
            min-width: 200px;
        }

        /* Notification Area */
        .notification-area {
            padding: 12px;
            margin: 15px 0;
            border-radius: 6px;
            text-align: center;
            font-weight: 500;
            display: none; /* Hidden by default */
        }
        .notification-area.success {
            background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block;
        }
        .notification-area.error {
            background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block;
        }
        .notification-area.info {
            background-color: #cce5ff; color: #004085; border: 1px solid #b8daff; display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Personal Sales Tracker</h1>
        <div id="notificationArea" class="notification-area"></div>

        <!-- Sections (HTML structure is the same as v2, not repeated for brevity) -->
        <div class="settings-section">
            <h2>Global Settings</h2>
            <div id="productManagementSection">
                <h3>Product Prices</h3>
                <div id="productList"></div>
                <input type="text" id="newProductName" placeholder="Product Name (Unique)">
                <input type="number" id="newProductPrice" placeholder="Default Price/Unit" step="0.01" min="0">
                <input type="number" id="newProductCommissionPerUnit" placeholder="Default Commission/Unit" step="0.01" min="0">
                <input type="hidden" id="editingProductId">
                <button id="addProductButton">Add/Update Product</button>
                <button id="cancelEditProductButton" class="secondary" style="display:none;">Cancel Edit</button>
            </div>
            <hr style="margin: 15px 0;">
            <div id="customFieldManagementSection">
                <h3>Custom Data Fields (Additional Cells)</h3>
                <p style="font-size:0.85em; color: #606770;">Define extra text fields for each sale.</p>
                <div id="customFieldsList"></div>
                <input type="text" id="newCustomFieldName" placeholder="New Field Name (e.g., Customer Note)">
                <button id="addCustomFieldButton">Add Custom Field</button>
            </div>
        </div>
        <hr>
        <div class="form-section">
            <h2>Add New Sale</h2>
            <form id="saleForm">
                <div><label for="saleDate">Date:</label><input type="date" id="saleDate" required></div>
                <div><label for="itemName">Item Name:</label><select id="itemName" required><option value="">-- Select Product --</option></select><input type="text" id="customItemName" placeholder="Or type new item name" style="display:none; margin-top:5px;"></div>
                <div><label for="quantity">Quantity:</label><input type="number" id="quantity" value="1" min="1" required></div>
                <div><label for="itemPrice">Item Price (per unit):</label><input type="number" id="itemPrice" step="0.01" min="0" required></div>
                <div><label for="commission">Commission (Total for this sale):</label><input type="number" id="commission" value="0" step="0.01" min="0"></div>
                <div><label for="vaiWillPay">Vai Will Pay:</label><input type="number" id="vaiWillPay" value="0" step="0.01" min="0"></div>
                <div id="saleEntryCustomFieldsContainer"></div>
                <button type="submit">Add Sale</button>
            </form>
        </div>
        <hr>
        <h2>Sales Records</h2>
        <div class="button-group">
            <button id="exportPdfButton">Export to PDF</button>
            <button id="backupDataButton" class="secondary">Backup Data (JSON)</button>
        </div>
        <div><label for="restoreDataInput" style="margin-top:10px;">Restore Data (from .json backup):</label><input type="file" id="restoreDataInput" accept=".json" style="padding: 5px;"></div>
        <div class="table-responsive">
             <table id="salesTable">
                <thead><tr id="salesTableHeaderRow"><th>Day</th><th>Date</th><th>Item Name</th><th>Qty</th><th>Item Price</th><th>Total Item Price</th><th>Commission</th><th>Vai Will Pay</th><th>(Pure)Profit This Entry</th><th>Actions</th></tr></thead>
                <tbody id="salesTableBody"></tbody>
            </table>
        </div>
        <div id="summarySection">
            <h3>Summary Totals (All Time)</h3>
            <p><strong>Total Sold Item Prices:</strong> $<span id="sumTotalSoldPrices">0.00</span></p>
            <p><strong>Total Commission:</strong> $<span id="sumTotalCommission">0.00</span></p>
            <p><strong>Total "Vai Will Pay":</strong> $<span id="sumTotalVaiWillPay">0.00</span></p>
            <p><strong>(Pure) Total Profit:</strong> $<span id="sumTotalPureProfit">0.00</span></p>
            <p><strong>Number of Sales Days:</strong> <span id="sumNumberOfDays">0</span></p>
            <p><strong>(Pure) Average Profit Per Day:</strong> $<span id="sumAverageProfitPerDay">0.00</span></p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
        // --- JAVASCRIPT LOGIC (DOM elements are the same as v2) ---
        document.addEventListener('DOMContentLoaded', () => {
            const notificationArea = document.getElementById('notificationArea');
            const productListDiv = document.getElementById('productList');
            const newProductNameInput = document.getElementById('newProductName');
            const newProductPriceInput = document.getElementById('newProductPrice');
            const newProductCommissionPerUnitInput = document.getElementById('newProductCommissionPerUnit'); 
            const editingProductIdInput = document.getElementById('editingProductId'); 
            const addProductButton = document.getElementById('addProductButton');
            const cancelEditProductButton = document.getElementById('cancelEditProductButton');
            const customFieldsListDiv = document.getElementById('customFieldsList');
            const newCustomFieldNameInput = document.getElementById('newCustomFieldName');
            const addCustomFieldButton = document.getElementById('addCustomFieldButton');
            const saleEntryCustomFieldsContainer = document.getElementById('saleEntryCustomFieldsContainer');
            const salesTableHeaderRow = document.getElementById('salesTableHeaderRow');
            const saleForm = document.getElementById('saleForm');
            const saleDateInput = document.getElementById('saleDate');
            const itemNameSelect = document.getElementById('itemName');
            const customItemNameInput = document.getElementById('customItemName');
            const quantityInput = document.getElementById('quantity');
            const itemPriceInput = document.getElementById('itemPrice');
            const commissionInput = document.getElementById('commission'); 
            const vaiWillPayInput = document.getElementById('vaiWillPay');
            const salesTableBody = document.getElementById('salesTableBody');
            const exportPdfButton = document.getElementById('exportPdfButton');
            const backupDataButton = document.getElementById('backupDataButton');
            const restoreDataInput = document.getElementById('restoreDataInput');
            const sumTotalSoldPricesSpan = document.getElementById('sumTotalSoldPrices');
            const sumTotalCommissionSpan = document.getElementById('sumTotalCommission');
            const sumTotalVaiWillPaySpan = document.getElementById('sumTotalVaiWillPay');
            const sumTotalPureProfitSpan = document.getElementById('sumTotalPureProfit');
            const sumNumberOfDaysSpan = document.getElementById('sumNumberOfDays');
            const sumAverageProfitPerDaySpan = document.getElementById('sumAverageProfitPerDay');

            let products = JSON.parse(localStorage.getItem('salesAppProducts_AIO_v2')) || [];
            let salesRecords = JSON.parse(localStorage.getItem('salesAppRecords_AIO_v2')) || [];
            let definedCustomFields = JSON.parse(localStorage.getItem('salesAppCustomFields_AIO_v2')) || [];

            function showNotification(message, type = 'info', duration = 3000) { /* ... same ... */ 
                notificationArea.textContent = message;
                notificationArea.className = 'notification-area ' + type;
                setTimeout(() => {
                    notificationArea.className = 'notification-area'; 
                }, duration);
            }
            function saveProducts() { localStorage.setItem('salesAppProducts_AIO_v2', JSON.stringify(products)); }
            function saveSalesRecords() { localStorage.setItem('salesAppRecords_AIO_v2', JSON.stringify(salesRecords)); }
            function saveCustomFields() { localStorage.setItem('salesAppCustomFields_AIO_v2', JSON.stringify(definedCustomFields)); }
            function getDayName(dateString) { /* ... same ... */ 
                const date = new Date(dateString + 'T00:00:00');
                return date.toLocaleDateString(undefined, { weekday: 'short' });
            }
            function generateId() { /* ... same ... */ 
                return Date.now().toString(36) + Math.random().toString(36).substring(2);
            }

            // --- Product Management (Same as v2) ---
             function renderProductList() { /* ... same ... */ 
                productListDiv.innerHTML = '';
                products.forEach(product => {
                    const div = document.createElement('div');
                    div.classList.add('list-item'); 
                    div.innerHTML = `
                        <div class="list-item-info">
                            <span class="field-name-display">${product.name}</span><br>
                            <small>Price: $${parseFloat(product.price).toFixed(2)} | Comm/Unit: $${parseFloat(product.commissionPerUnit || 0).toFixed(2)}</small>
                        </div>
                        <div class="list-item-actions">
                            <button class="secondary action-button edit-product" data-id="${product.id}">Edit</button>
                            <button class="danger action-button delete-product" data-id="${product.id}">Delete</button>
                        </div>`;
                    productListDiv.appendChild(div);
                });
                populateItemNameDropdown();
            }
            function clearProductForm() { /* ... same ... */ 
                newProductNameInput.value = '';
                newProductPriceInput.value = '';
                newProductCommissionPerUnitInput.value = ''; 
                editingProductIdInput.value = ''; 
                addProductButton.textContent = 'Add Product';
                cancelEditProductButton.style.display = 'none';
                newProductNameInput.disabled = false; 
            }
            productListDiv.addEventListener('click', (e) => { /* ... same ... */ 
                if (e.target.classList.contains('delete-product')) {
                    const productId = e.target.dataset.id;
                    if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                        products = products.filter(p => p.id !== productId);
                        saveProducts();
                        renderProductList();
                        if (editingProductIdInput.value === productId) { 
                            clearProduct_form();
                        }
                        showNotification('Product deleted.', 'success');
                    }
                } else if (e.target.classList.contains('edit-product')) {
                    const productId = e.target.dataset.id;
                    const productToEdit = products.find(p => p.id === productId);
                    if (productToEdit) {
                        newProductNameInput.value = productToEdit.name;
                        newProductPriceInput.value = productToEdit.price.toFixed(2);
                        newProductCommissionPerUnitInput.value = (productToEdit.commissionPerUnit || 0).toFixed(2);
                        editingProductIdInput.value = productToEdit.id; 
                        addProductButton.textContent = 'Update Product';
                        cancelEditProductButton.style.display = 'inline-block';
                        newProductNameInput.disabled = true; 
                        newProductPriceInput.focus();
                    }
                }
            });
            cancelEditProductButton.addEventListener('click', clearProductForm);
            function populateItemNameDropdown() { /* ... same ... */ 
                const originalValue = itemNameSelect.value;
                itemNameSelect.innerHTML = '<option value="">-- Select Product --</option>';
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.name; 
                    option.textContent = product.name;
                    option.dataset.price = product.price;
                    option.dataset.commissionPerUnit = product.commissionPerUnit || 0; 
                    itemNameSelect.appendChild(option);
                });
                const newOption = document.createElement('option');
                newOption.value = "__NEW__";
                newOption.textContent = "-- Add New Item --";
                itemNameSelect.appendChild(newOption);
                if (products.find(p => p.name === originalValue) || originalValue === "__NEW__") {
                     itemNameSelect.value = originalValue; 
                } else {
                     itemNameSelect.value = "";
                }
            }
            addProductButton.addEventListener('click', () => { /* ... same ... */ 
                const name = newProductNameInput.value.trim();
                const price = parseFloat(newProductPriceInput.value);
                const commissionPerUnit = parseFloat(newProductCommissionPerUnitInput.value) || 0; 
                const editingId = editingProductIdInput.value;

                if (!name || isNaN(price) || price < 0 || isNaN(commissionPerUnit) || commissionPerUnit < 0) {
                    showNotification('Valid product name, price, and commission/unit required.', 'error');
                    return;
                }

                if (editingId) { 
                    const productIndex = products.findIndex(p => p.id === editingId);
                    if (productIndex > -1) {
                        products[productIndex].price = price;
                        products[productIndex].commissionPerUnit = commissionPerUnit; 
                        showNotification('Product updated!', 'success');
                    }
                } else { 
                    const existingProduct = products.find(p => p.name.toLowerCase() === name.toLowerCase());
                    if (existingProduct) {
                        showNotification('Product name already exists. Edit the existing one or use a different name.', 'error');
                        return;
                    }
                    products.push({ id: generateId(), name, price, commissionPerUnit }); 
                    showNotification('Product added!', 'success');
                }
                saveProducts();
                renderProductList();
                clearProductForm();
            });
            function updateCommissionBasedOnProductAndQuantity() { /* ... same ... */ 
                const selectedOption = itemNameSelect.options[itemNameSelect.selectedIndex];
                const quantity = parseInt(quantityInput.value) || 0;

                if (selectedOption && selectedOption.dataset.commissionPerUnit && quantity > 0) {
                    const commissionPerUnit = parseFloat(selectedOption.dataset.commissionPerUnit);
                    commissionInput.value = (commissionPerUnit * quantity).toFixed(2);
                } else if (selectedOption.value !== "__NEW__" && selectedOption.value !== "") { 
                     commissionInput.value = "0.00";
                } else if (selectedOption.value === "") { 
                    commissionInput.value = "0.00"; 
                }
            }
            itemNameSelect.addEventListener('change', (e) => { /* ... same ... */ 
                const selectedOption = e.target.options[e.target.selectedIndex];
                customItemNameInput.style.display = 'none';
                if (selectedOption.value === "__NEW__") {
                    customItemNameInput.style.display = 'block';
                    customItemNameInput.value = ''; 
                    itemPriceInput.value = ''; 
                    commissionInput.value = '0.00'; 
                    customItemNameInput.focus();
                } else if (selectedOption.dataset.price) {
                    itemPriceInput.value = parseFloat(selectedOption.dataset.price).toFixed(2);
                    updateCommissionBasedOnProductAndQuantity(); 
                } else {
                    itemPriceInput.value = '';
                    commissionInput.value = '0.00'; 
                }
            });
            quantityInput.addEventListener('input', updateCommissionBasedOnProductAndQuantity);

            // --- Custom Field (Cell) Management (Same as v2) ---
            function renderCustomFieldsList() { /* ... same ... */ 
                customFieldsListDiv.innerHTML = '';
                definedCustomFields.forEach(field => {
                    const div = document.createElement('div');
                    div.classList.add('list-item');
                    div.innerHTML = `<div class="list-item-info"><span class="field-name-display">${field.name}</span></div>
                                     <div class="list-item-actions"><button class="danger action-button" data-id="${field.id}">Delete</button></div>`;
                    customFieldsListDiv.appendChild(div);
                });
                renderCustomFieldInputsForEntry();
                renderSalesTable(); 
            }
            customFieldsListDiv.addEventListener('click', (e) => { /* ... same ... */ 
                if (e.target.tagName === 'BUTTON' && e.target.dataset.id && e.target.classList.contains('danger')) { 
                    const fieldIdToDelete = e.target.dataset.id;
                    const fieldNameToDelete = definedCustomFields.find(f=>f.id === fieldIdToDelete)?.name;
                     if (confirm(`Are you sure you want to delete the custom field "${fieldNameToDelete}"? This will also remove its data from existing sales records.`)) {
                        definedCustomFields = definedCustomFields.filter(f => f.id !== fieldIdToDelete);
                        salesRecords.forEach(record => {
                            if (record.customData && record.customData[fieldIdToDelete]) {
                                delete record.customData[fieldIdToDelete];
                            }
                        });
                        saveCustomFields();
                        saveSalesRecords();
                        renderCustomFieldsList(); 
                        showNotification('Custom field deleted.', 'success');
                    }
                }
            });
            addCustomFieldButton.addEventListener('click', () => { /* ... same ... */ 
                const name = newCustomFieldNameInput.value.trim();
                if (name && !definedCustomFields.find(f => f.name.toLowerCase() === name.toLowerCase())) {
                    definedCustomFields.push({ id: 'cf_' + generateId(), name: name });
                    saveCustomFields();
                    renderCustomFieldsList();
                    newCustomFieldNameInput.value = '';
                    showNotification('Custom field added!', 'success');
                } else if (!name) {
                    showNotification('Custom field name cannot be empty.', 'error');
                } else {
                    showNotification('Custom field name already exists.', 'error');
                }
            });
            function renderCustomFieldInputsForEntry() { /* ... same ... */ 
                saleEntryCustomFieldsContainer.innerHTML = '';
                definedCustomFields.forEach(field => {
                    const div = document.createElement('div');
                    const label = document.createElement('label');
                    label.htmlFor = `customFieldInput_${field.id}`;
                    label.textContent = field.name + ':';
                    const input = document.createElement('input');
                    input.type = 'text'; 
                    input.id = `customFieldInput_${field.id}`;
                    input.dataset.fieldId = field.id;
                    input.placeholder = field.name;
                    div.appendChild(label);
                    div.appendChild(input);
                    saleEntryCustomFieldsContainer.appendChild(div);
                });
            }

            // --- Sales Record Management (Same as v2) ---
            saleForm.addEventListener('submit', (e) => { /* ... same ... */ 
                e.preventDefault();
                let itemNameValue = itemNameSelect.value;
                if (itemNameValue === "__NEW__") { 
                    itemNameValue = customItemNameInput.value.trim();
                    if (!itemNameValue) {
                        showNotification('New item name cannot be empty.', 'error');
                        return;
                    }
                }

                const customData = {};
                saleEntryCustomFieldsContainer.querySelectorAll('input[data-field-id]').forEach(input => {
                    if (input.value.trim()) {
                        customData[input.dataset.fieldId] = input.value.trim();
                    }
                });

                if (saleDateInput.value && itemNameValue && quantityInput.value > 0 && parseFloat(itemPriceInput.value) >= 0) {
                    const newSale = {
                        id: generateId(),
                        date: saleDateInput.value,
                        itemName: itemNameValue, 
                        quantity: parseInt(quantityInput.value),
                        itemPrice: parseFloat(itemPriceInput.value),
                        commissionEntry: parseFloat(commissionInput.value) || 0,
                        vaiWillPayEntry: parseFloat(vaiWillPayInput.value) || 0,
                        customData: customData
                    };
                    salesRecords.push(newSale);
                    saveSalesRecords();
                    renderSalesTable();
                    saleForm.reset(); 
                    saleDateInput.valueAsDate = new Date();
                    customItemNameInput.style.display = 'none'; 
                    itemNameSelect.value = ""; 
                    itemPriceInput.value = ""; 
                    commissionInput.value = "0.00"; 
                    renderCustomFieldInputsForEntry(); 
                    showNotification('Sale added!', 'success');
                } else { showNotification('Please fill all required fields correctly (Date, Item Name, Quantity > 0, Price >= 0).', 'error'); }
            });
            function renderSalesTable() { /* ... same ... */ 
                salesTableBody.innerHTML = '';
                salesTableHeaderRow.innerHTML = `
                    <th>Day</th><th>Date</th><th>Item Name</th><th>Qty</th><th>Item Price</th>
                    <th>Total Item Price</th><th>Commission</th><th>Vai Will Pay</th><th>(Pure)Profit This Entry</th>
                `;
                definedCustomFields.forEach(cf => {
                    const th = document.createElement('th');
                    th.textContent = cf.name;
                    salesTableHeaderRow.appendChild(th);
                });
                const actionsTh = document.createElement('th');
                actionsTh.textContent = 'Actions';
                salesTableHeaderRow.appendChild(actionsTh);


                const sortedRecords = [...salesRecords].sort((a, b) => new Date(b.date) - new Date(a.date));
                sortedRecords.forEach(sale => {
                    const row = salesTableBody.insertRow();
                    const totalItemPrice = sale.quantity * sale.itemPrice;
                    const pureProfitThisEntry = totalItemPrice - sale.commissionEntry - sale.vaiWillPayEntry;

                    row.insertCell().textContent = getDayName(sale.date);
                    row.insertCell().textContent = sale.date;
                    row.insertCell().textContent = sale.itemName;
                    row.insertCell().textContent = sale.quantity;
                    row.insertCell().textContent = `$${sale.itemPrice.toFixed(2)}`;
                    row.insertCell().textContent = `$${totalItemPrice.toFixed(2)}`;
                    row.insertCell().textContent = `$${sale.commissionEntry.toFixed(2)}`;
                    row.insertCell().textContent = `$${sale.vaiWillPayEntry.toFixed(2)}`;
                    row.insertCell().textContent = `$${pureProfitThisEntry.toFixed(2)}`;

                    definedCustomFields.forEach(cf => {
                        row.insertCell().textContent = (sale.customData && sale.customData[cf.id]) ? sale.customData[cf.id] : '';
                    });

                    const actionsCell = row.insertCell();
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('danger', 'action-button');
                    deleteButton.onclick = () => deleteSale(sale.id);
                    actionsCell.appendChild(deleteButton);
                });
                calculateAndDisplaySummary();
            }
            function deleteSale(saleId) { /* ... same ... */ 
                if (confirm('Are you sure you want to delete this sale record?')) {
                    salesRecords = salesRecords.filter(sale => sale.id !== saleId);
                    saveSalesRecords();
                    renderSalesTable();
                    showNotification('Sale record deleted.', 'success');
                }
            }

            // --- Calculations for Summary (Same as v2) ---
            function calculateAndDisplaySummary() { /* ... same ... */ 
                let totalSold = 0, totalCommission = 0, totalVai = 0, totalPureProfit = 0;
                const dailyProfits = {};
                salesRecords.forEach(sale => {
                    const entryTotalItemPrice = sale.quantity * sale.itemPrice;
                    const entryPureProfit = entryTotalItemPrice - sale.commissionEntry - sale.vaiWillPayEntry;
                    totalSold += entryTotalItemPrice;
                    totalCommission += sale.commissionEntry;
                    totalVai += sale.vaiWillPayEntry;
                    totalPureProfit += entryPureProfit;
                    if (!dailyProfits[sale.date]) { dailyProfits[sale.date] = 0; }
                    dailyProfits[sale.date] += entryPureProfit;
                });
                sumTotalSoldPricesSpan.textContent = totalSold.toFixed(2);
                sumTotalCommissionSpan.textContent = totalCommission.toFixed(2);
                sumTotalVaiWillPaySpan.textContent = totalVai.toFixed(2);
                sumTotalPureProfitSpan.textContent = totalPureProfit.toFixed(2);
                const numberOfDays = Object.keys(dailyProfits).length;
                sumNumberOfDaysSpan.textContent = numberOfDays;
                sumAverageProfitPerDaySpan.textContent = (numberOfDays > 0 ? (totalPureProfit / numberOfDays) : 0).toFixed(2);
                return { totalSold, totalCommission, totalVai, totalPureProfit, numberOfDays, dailyProfits };
            }

            // --- PDF Export ---
            // VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV
            // UPDATED PDF EXPORT FUNCTION WITH MORE ROBUST ERROR CHECKING
            // VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV
            exportPdfButton.addEventListener('click', () => {
                // Check if the main jsPDF library object exists and has the jsPDF constructor
                if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                    showNotification('jsPDF library not loaded. Check internet connection if using CDN, or ensure the library file is present.', 'error');
                    console.error("PDF Export Error: window.jspdf or window.jspdf.jsPDF is not defined.");
                    return;
                }

                const { jsPDF: JSPDF } = window.jspdf; // Get the jsPDF constructor
                const doc = new JSPDF();

                // Check if the autoTable plugin is available on the instance
                if (typeof doc.autoTable !== 'function') {
                    showNotification('jsPDF-AutoTable plugin not loaded or not attached correctly. Ensure jspdf.plugin.autotable.min.js is loaded AFTER jspdf.umd.min.js.', 'error');
                    console.error("PDF Export Error: doc.autoTable is not a function.");
                    return;
                }
                
                try {
                    doc.setFontSize(18); 
                    doc.text('Personal Sales Report', 14, 22);
                    doc.setFontSize(11); 
                    doc.setTextColor(100);
                    
                    const summary = calculateAndDisplaySummary();
                    let yPos = 30; // Initial Y position for summary text
                    doc.text(`Total Sold Item Prices: $${summary.totalSold.toFixed(2)}`, 14, yPos); yPos += 6;
                    doc.text(`Total Commission: $${summary.totalCommission.toFixed(2)}`, 14, yPos); yPos += 6;
                    doc.text(`Total "Vai Will Pay": $${summary.totalVai.toFixed(2)}`, 14, yPos); yPos += 6;
                    doc.text(`(Pure) Total Profit: $${summary.totalPureProfit.toFixed(2)}`, 14, yPos); yPos += 6;
                    doc.text(`Number of Sales Days: ${summary.numberOfDays}`, 14, yPos); yPos += 6;
                    const avgProfit = (summary.numberOfDays > 0 ? summary.totalPureProfit / summary.numberOfDays : 0).toFixed(2);
                    doc.text(`(Pure) Average Profit Per Day: $${avgProfit}`, 14, yPos); 
                    yPos += 10; // Add more space before the table

                    const head = [
                        ['Day', 'Date', 'Item', 'Qty', 'Price', 'Total Price', 'Comm.', 'Vai Paid', 'Entry Profit']
                    ];
                    definedCustomFields.forEach(cf => head[0].push(cf.name));

                    const body = salesRecords.map(sale => {
                        const totalItemPrice = sale.quantity * sale.itemPrice;
                        const pureProfitThisEntry = totalItemPrice - sale.commissionEntry - sale.vaiWillPayEntry;
                        const rowData = [
                            getDayName(sale.date), sale.date, sale.itemName, sale.quantity,
                            `$${sale.itemPrice.toFixed(2)}`, `$${totalItemPrice.toFixed(2)}`,
                            `$${sale.commissionEntry.toFixed(2)}`, `$${sale.vaiWillPayEntry.toFixed(2)}`,
                            `$${pureProfitThisEntry.toFixed(2)}`
                        ];
                        definedCustomFields.forEach(cf => {
                            rowData.push((sale.customData && sale.customData[cf.id]) ? sale.customData[cf.id] : '');
                        });
                        return rowData;
                    });

                    doc.autoTable({ 
                        startY: yPos, 
                        head: head, 
                        body: body, 
                        theme: 'striped', 
                        headStyles: { fillColor: [22, 160, 133] }, 
                        styles: { fontSize: 7, cellPadding: 1.5, overflow: 'linebreak' }, // Added overflow linebreak
                        columnStyles: { // Example: make first column slightly wider
                            // 0: { cellWidth: 20 }, 
                        }
                    });
                    doc.save(`sales-report-${new Date().toISOString().slice(0,10)}.pdf`);
                    showNotification('PDF report generated.', 'success');

                } catch (error) {
                    showNotification('Error generating PDF. Check console for details.', 'error');
                    console.error("Error during PDF generation (autoTable/save):", error);
                }
            });
            // ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

            // --- Data Backup and Restore (Same as v2) ---
            backupDataButton.addEventListener('click', () => { /* ... same ... */ 
                try {
                    const dataToBackup = { products, salesRecords, definedCustomFields };
                    if (products.length === 0 && salesRecords.length === 0 && definedCustomFields.length === 0) {
                        showNotification('No data to backup.', 'info'); return;
                    }
                    const dataStr = JSON.stringify(dataToBackup, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const linkElement = document.createElement('a');
                    linkElement.href = url;
                    linkElement.download = `sales_tracker_aio_v2_backup_${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(linkElement); linkElement.click(); document.body.removeChild(linkElement);
                    URL.revokeObjectURL(url);
                    showNotification('Data backup file downloading.', 'success');
                } catch (e) { showNotification('Error creating backup.', 'error'); console.error(e); }
            });
            restoreDataInput.addEventListener('change', (event) => { /* ... same ... */ 
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const restored = JSON.parse(e.target.result);
                            if (restored && typeof restored.products !== 'undefined' && 
                                typeof restored.salesRecords !== 'undefined' && 
                                typeof restored.definedCustomFields !== 'undefined') { 
                                if (confirm('This will overwrite ALL current data. Are you sure?')) {
                                    products = restored.products;
                                    salesRecords = restored.salesRecords;
                                    definedCustomFields = restored.definedCustomFields;
                                    saveProducts(); saveSalesRecords(); saveCustomFields();
                                    init(); 
                                    showNotification('Data restored successfully!', 'success');
                                }
                            } else { showNotification('Invalid backup file format. Missing expected data sections.', 'error'); }
                        } catch (err) { showNotification('Error parsing backup file.', 'error'); console.error(err); }
                        finally { restoreDataInput.value = ""; } 
                    };
                    reader.readAsText(file);
                }
            });

            // --- Initialization ---
            function init() {
                saleDateInput.valueAsDate = new Date();
                clearProductForm(); 
                renderProductList();
                renderCustomFieldsList(); 
                showNotification('App initialized.', 'info', 1500);
            }
            init();
        });
    </script>
</body>
</html>
